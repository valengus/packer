- hosts: all

  vars:

    ansible_connection: winrm
    ansible_winrm_scheme: https
    ansible_winrm_server_cert_validation: ignore
    ansible_winrm_connection_timeout: 3600 
    ansible_winrm_operation_timeout_sec: 3600 
    ansible_winrm_read_timeout_sec: 3600

    ansible_user: vagrant
    ansible_password: vagrant
    ansible_become_method: runas
    ansible_become_flags: logon_type=batch
    ansible_become_user: "{{ ansible_user }}"
    ansible_become_password: "{{ ansible_password }}"

  tasks:

  - debug:
      var: ansible_facts

  - name: check if sysprep is running
    win_shell: |
      $sysprep = Get-Process sysprep -ErrorAction SilentlyContinue
      if ($sysprep -eq $null) { exit 0 } else { exit 1 }

  # - name: search for Windows updates 
  #   win_updates:
  #     state: searched
  #   register: update_search_result

  # - name: show updates to install
  #   debug:
  #     msg: "{{ update_search_result }}"

  # - name: pre reboot, if needed
  #   win_reboot:
  #     reboot_timeout: 6000
  #   when: update_search_result.reboot_required

  # - name: Install Windows Updates
  #   win_updates:
  #   register: update_result

  # - name: show update_result
  #   debug:
  #     msg: "{{ update_result }}"